This folder demonstrates the use of the rnetwork package and some example schedulers.

The schedulers have their own README inside the `schedulers` folder. Important to note that the schedulers are parameterized via environment variables!

- It will basically setup a Python virtual environment to install the `rnetwork` (located in the directory above) package into.
- Compile the example schedulers.
- Inside the `instances` folder are subfolders each with `instances.toml` and `model_configuration.toml`.
    - Model configuration determines the parameters of the rotor network, such as number of nodes, bandwidth, buffer capacity, how many flows and their distribution, the queries to be run.
    - Instances configuration picks schedulers and assign their parameters that are to be run against the model.
    - Based on the network model and instance configurations UPPAAL models are generated inside folders based on the names from the instances configuration.
- The UPPAAL models are run using `verifyta` (which must be on the path) and the output dumped into the folder-local `verifyta.log`.
- Then the log is parsed to retrieve "UppaalSegments" which are basically the traces extracted. Each UppaalSegment contains:
    - The entire formula expression
    - Whether the formula is satisfied
    - The index of the formula (the order inside the model)
    - For each comma-separated expression in the formula, there are 1 or more samples stored representing the "curve" of the value during the run.
- From the UPPAAL segments plots are generated and across all the experiments plots comparing them are generated by `./scripts/common_plots_paper.py`.

Inside the generated subfolders there are `uppaal.sh` scripts alongside the generated `model.xml` files. These scripts must be run from this root such that the schedulers' .so files can be found. They launch UPPAAL on the `model.xml` files with the necessary environment variables set that the schedulers must be run with.

# Requirements

The following programs must be on the PATH (`python3`, `verifyta`, `cmake`)

- Python 3.8+
- UPPAAL Stratego 5+ . 
- CMake 3.19.1+ and C++ 17 compiler

# Setup

The `setup.sh` script will create a virtual environment and install the Python package 'rnetwork' into.

# Running UPPAAL and Generating Plots.

Requires `UPPAAL_KEY` to be set to your uppaal licence GUID in the environment and must be run from this root and the UPPAAL program `verifyta` to be reachable (it lives next to the UPPAAL binary). 

The script `run_and_generate_plots.sh` will:

1. Build the schedulers
2. Load the Python virtual environment.
3. Will generate UPPAAL models based on the model configuration inside the case_study folders.
4. Run UPPAAL (the command line tool `verifyta`) to run queries for `paper_1` and `paper_2` inside the `demonstration` folder.
5. Generate individual plots (inside each scheduler folder), and combined overview plots of latency and port utilizations in the main subfolder.

Example:

```sh
UPPAAL_KEY=MY_UPPAAL_LICENSE_GUID ./run_and_generate_plots.sh
```

The script `clean.sh` will delete the build tree for the schedulers, delete the copied scheduler .so files, and delete any artefact generated by running for the instances.
*Be sure* to change the script if persistent files are added to `./instances` folder. The script *will NOT* delete the virtual environment folder venv!

